{"version":3,"file":"index.js","sources":["../src/global-this.js","../src/constants.js","../src/is-jpeg.js","../src/get-exif-position.js","../src/is-tiff-align-little-endian.js","../src/is-boolean.js","../src/validate-exif-data.js","../src/get-orientation.js","../src/index.js"],"sourcesContent":["// eslint-disable-next-line no-new-func\nconst globalThis = new Function('return this')()\n\nexport default globalThis\n","// https://www.media.mit.edu/pia/Research/deepview/exif.html\nexport const SOI_MARKER = 0xffd8\nexport const APP1_MARKER = 0xffe1\nexport const EXIF_START = 0x45786966\nexport const TIFF_ALIGN_INTEL = 0x4949\nexport const TIFF_ALIGN_MOTOROLA = 0x4d4d\nexport const TIFF_TAG_MARK = 0x002a\nexport const TIFF_FIRST_IFD_OFFSET = 0x00000008\nexport const TIFF_ORIENTATION_TAG_NO = 0x0112\n","import {SOI_MARKER} from './constants'\n\nfunction isJPEG(view) {\n  return view.getUint16(0) === SOI_MARKER\n}\n\nexport default isJPEG\n","import {APP1_MARKER} from './constants'\n\n// https://github.com/dominictarr/exif-orientation-lite/blob/master/index.js\n// https://github.com/exif-js/exif-js/blob/master/exif.js\n\nfunction getExifPosition(view) {\n  const {byteLength} = view\n\n  let offset = 2\n  while (offset < byteLength) {\n    // Not a valid marker\n    if (view.getUint8(offset) !== 0xff) {\n      return null\n    }\n\n    const marker = view.getUint16(offset)\n\n    if (marker === APP1_MARKER) {\n      return offset + 4\n    }\n\n    offset += 2\n    offset += view.getUint16(offset)\n  }\n\n  /* istanbul ignore next */\n  return null\n}\n\nexport default getExifPosition\n","import {TIFF_ALIGN_MOTOROLA, TIFF_ALIGN_INTEL} from './constants'\n\nfunction isLittleEndian(view, offset) {\n  const tiffAlign = view.getUint16(offset)\n\n  if (tiffAlign === TIFF_ALIGN_INTEL) {\n    return true\n  }\n\n  if (tiffAlign === TIFF_ALIGN_MOTOROLA) {\n    return false\n  }\n\n  /* istanbul ignore next */\n  // \"Not valid TIFF data! (no 0x4949 or 0x4D4D)\"\n  return null\n}\n\nexport default isLittleEndian\n","function isBoolean(x) {\n  return x === true || x === false\n}\n\nexport default isBoolean\n","import {EXIF_START, TIFF_FIRST_IFD_OFFSET, TIFF_TAG_MARK} from './constants'\nimport isLittleEndia from './is-tiff-align-little-endian'\nimport isBoolean from './is-boolean'\n\nfunction validateEXIFData(view, offset) {\n  // Not valid EXIF data! NO 'Exif' found\n  if (\n    view.getUint32(offset) !== EXIF_START ||\n    view.getUint16(offset + 4) !== 0x0000\n  ) {\n    return false\n  }\n\n  const tiffOffset = offset + 6\n  const littleEndian = isLittleEndia(view, tiffOffset)\n\n  /* istanbul ignore if */\n  if (!isBoolean(littleEndian)) {\n    return false\n  }\n\n  /* istanbul ignore if */\n  // \"Not valid TIFF data! (no 0x002A)\"\n  if (view.getUint16(tiffOffset + 2, littleEndian) !== TIFF_TAG_MARK) {\n    return false\n  }\n\n  const firstIFDOffset = view.getUint32(tiffOffset + 4, littleEndian)\n\n  /* istanbul ignore if */\n  if (firstIFDOffset < TIFF_FIRST_IFD_OFFSET) {\n    // Not valid TIFF data! (First offset less than 8)\n    return false\n  }\n\n  return {\n    tiffOffset,\n    littleEndian,\n    firstIFDOffset,\n  }\n}\n\nexport default validateEXIFData\n","import {TIFF_ORIENTATION_TAG_NO} from './constants'\n\nimport validateEXIFData from './validate-exif-data'\n\nfunction getOrientation(view, offset) {\n  const result = validateEXIFData(view, offset)\n\n  if (!result) {\n    return\n  }\n\n  const {tiffOffset, littleEndian, firstIFDOffset} = result\n\n  const tags = view.getUint16(firstIFDOffset, littleEndian)\n  const start = tiffOffset + firstIFDOffset\n\n  for (let i = 0; i < tags; i += 1) {\n    const entryOffset = start + i * 12 + 2\n\n    if (entryOffset > view.byteLength - 16) {\n      return\n    }\n\n    // skip type check\n    // var type = view.getUint16(entryOffset+2, littleEndian)\n    // var numValues = view.getUint32(entryOffset+4, littleEndian)\n    const tiffTagNumber = view.getUint16(entryOffset, littleEndian)\n    if (tiffTagNumber === TIFF_ORIENTATION_TAG_NO) {\n      const orientation = view.getUint16(entryOffset + 8, littleEndian)\n      if (orientation < 1 || orientation > 8) {\n        return\n      }\n      return orientation\n    }\n  }\n}\n\nexport default getOrientation\n","// get orientation from a Arraybuffer\n// most codes from urls bellow\n// https://github.com/dominictarr/exif-orientation-lite/blob/master/index.js\n// https://github.com/exif-js/exif-js/blob/master/exif.js\n\nimport globalThis from './global-this'\nimport isJPEG from './is-jpeg'\nimport getExifPosition from './get-exif-position'\nimport getOrientation from './get-orientation'\n\nconst {DataView} = globalThis\n\nfunction orientation(buffer) {\n  const view = new DataView(buffer)\n\n  if (!isJPEG(view)) {\n    return\n  }\n\n  const exifOffset = getExifPosition(view)\n\n  if (!exifOffset) {\n    return\n  }\n\n  return getOrientation(view, exifOffset)\n}\n\nexport default orientation\n"],"names":["globalThis","Function","SOI_MARKER","APP1_MARKER","EXIF_START","TIFF_ALIGN_INTEL","TIFF_ALIGN_MOTOROLA","TIFF_TAG_MARK","TIFF_FIRST_IFD_OFFSET","TIFF_ORIENTATION_TAG_NO","isJPEG","view","getUint16","getExifPosition","byteLength","offset","getUint8","marker","isLittleEndian","tiffAlign","isBoolean","x","validateEXIFData","getUint32","tiffOffset","littleEndian","isLittleEndia","firstIFDOffset","getOrientation","result","tags","start","i","entryOffset","tiffTagNumber","orientation","DataView","buffer","exifOffset"],"mappings":"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"}